Vue.directive("select",{twoWay:true,bind:function(el,binding,vnode){$(el).select2().on("select2:select",function(e){el.dispatchEvent(new Event("change",{target:e.target}))})}});Vue.component("add-feature",{template:"#add-feature-template",data:function(){return{feature:{title:""}}},methods:{handleAddFeature:function(bvModalEvt){var self=this;bvModalEvt.preventDefault();var form=$("#frm-add-feature");if(form.parsley().validate()){var data={module:"items",method:"add_feature",obj:this.feature};var request=submitRequest(data,"put");request.then(function(response){if(response.status=="ok"){var obj={id:response.obj.id,value:response.obj.title};bus.$emit("new_feature_added",obj);self.$bvModal.hide("add-feature-modal")}})}}}});Vue.component("add-category",{template:"#add-category-template",data:function(){return{category:{title:"",parent:""}}},methods:{handleAddCategory:function(bvModalEvt){var self=this;bvModalEvt.preventDefault();var form=$("#frm-add-category");if(form.parsley().validate()){var data={module:"items",method:"add_category",obj:this.category};var request=submitRequest(data,"put");request.then(function(response){if(response.status=="ok"){var obj={id:response.obj.id,value:response.obj.title};bus.$emit("new_category_added",obj);self.$bvModal.hide("add-category-modal")}})}}}});var self=new Vue({el:"#item-form",data:function(){return{masters:{categories:[],features:[],units:[],subUnits:[{id:"",value:"Select Unit first"}],vendors:[]},item:{}}},watch:{"item.purchasePrice":{handler:function(after,before){self.item.purchasePrice=isNaN(after)?before:after},deep:true},"item.sellingPrice":{handler:function(after,before){self.item.sellingPrice=isNaN(after)?before:after},deep:true},"item.openingStock":{handler:function(after,before){self.item.openingStock=isNaN(after)?before:after},deep:true},"item.openingStockValue":{handler:function(after,before){self.item.openingStockValue=isNaN(after)?before:after},deep:true},"item.reorderLevel":{handler:function(after,before){self.item.reorderLevel=isNaN(after)?before:after},deep:true}},methods:{populateMeta:function(){var self=this;var data={module:"items",method:"populate"};var request=submitRequest(data,"get");request.then(function(response){if(response.status=="ok"){self.masters.categories=response.categories;self.masters.features=response.features;self.masters.units=response.units;self.masters.vendors=response.vendors}})},populateSingle:function(){var self=this;var method="get";var data={module:"items",method:"single",id:_s("id")};if(method){var request=submitRequest(data,method);request.then(function(response){if(response.status=="ok"){var obj=response.obj;self.item=obj;self.item.weight=Number(self.item.weight).toFixed(2);self.onUnitSelect("load")}})}},onUnitSelect:function(ref){var self=this;if(this.item.unit!=""){if(ref!="load"){self.item.purchaseUnit=null;self.item.saleUnit=null}var method="get";var data={module:"core/units",method:"sub_select_data",id:this.item.unit};if(method){var request=submitRequest(data,method);request.then(function(response){if(response.status=="ok"){self.masters.subUnits=response.subUnits;if(ref!="load"){self.item.purchaseUnit=self.item.purchaseUnit==null?self.item.unit:"";self.item.saleUnit=self.item.saleUnit==null?self.item.unit:""}}})}}},handleBlankFeature:function(){var newFeature={itemId:"",featureId:"",title:""};this.item.features.push(newFeature)},duplicateSku:function(string,field){var mode=_s("mode");if(mode=="edit"){return false}var result=false;$(field).parsley().removeError("sku_duplicate");var action=_s("action");var url=action+"?module=items&method=duplicate_sku&sku="+string;var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(this.status===200){var response=JSON.parse(this.responseText);result=response.result}};xhttp.open("GET",url,false);xhttp.send();return result},handleSubmit:function(){var form=$("#frm-item");var field=this.$refs.sku;if(form.parsley().validate()){if(!this.duplicateSku(this.item.sku,field)){var method="";var mode=_s("mode");if(mode=="add"){method="put"}else if(mode=="edit"){method="post"}var data={module:"items",obj:this.item};if(method){var request=submitRequest(data,method);request.then(function(response){if(response.status=="ok"){window.location=response.redirect}})}else{alert("Something went wrong!")}}else{$(field).parsley().addError("sku_duplicate",{message:"SKU already exists."})}}},cancel:function(){window.location=_s("back_url")}},created:function(){var mode=_s("mode");bus.$on("new_feature_added",function(feature){self.masters.features.push(feature)});bus.$on("new_category_added",function(category){self.masters.categories.push(category);self.item.categoryId=category.id});this.item={name:"",sku:"",skuId:"",categoryId:"",unit:"",purchaseUnit:null,saleUnit:null,weight:"",manufacturer:"",upc:"",ean:"",sellingPrice:"",purchasePrice:"",openingStock:"",openingStockValue:"",reorderLevel:"",preferredVendor:"",features:[]};this.populateMeta();if(mode=="edit"){this.populateSingle()}else{this.handleBlankFeature()}}});